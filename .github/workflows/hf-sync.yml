name: Sync to Hugging Face Space

on:
  # Only run after Tests workflow completes successfully
  workflow_run:
    workflows: ["Tests"]
    types: [completed]
    branches: [main]
  workflow_dispatch:

jobs:
  sync-to-hub:
    runs-on: ubuntu-latest
    # Only run if Tests workflow succeeded
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    env:
      HF_TOKEN: ${{ secrets.HF_TOKEN }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check token exists
        run: |
          if [ -z "$HF_TOKEN" ]; then
            echo "❌ HF_TOKEN secret is not set!"
            exit 1
          fi
          echo "✅ HF_TOKEN is set (length: ${#HF_TOKEN})"

      - name: Install huggingface_hub
        run: pip install huggingface_hub

      - name: Prepare files for upload
        run: |
          # Copy model files to backend data directory
          mkdir -p backend/data/models
          if [ -d "data/models" ]; then
            cp -r data/models/* backend/data/models/ 2>/dev/null || true
            echo "✅ Model files copied"
            ls -la backend/data/models/
          else
            echo "⚠️ No model files found in data/models/"
          fi

      - name: Upload backend to Space
        run: |
          cd backend
          python -c "
          from huggingface_hub import HfApi
          import os

          api = HfApi(token=os.environ['HF_TOKEN'])

          # Upload backend folder with ignore patterns for cleaner deployment
          api.upload_folder(
              folder_path='.',
              repo_id='ifieryarrows/copper-mind',
              repo_type='space',
              commit_message='Sync from GitHub (tests passed)',
              ignore_patterns=[
                  'tests/*',
                  '__pycache__/*',
                  '*.pyc',
                  '.pytest_cache/*',
                  'artifacts/*',
                  '*.egg-info/*'
              ]
          )
          print('✅ Upload complete!')
          "
