name: Daily Pipeline Trigger

on:
    schedule:
        # Run daily at 02:00 Istanbul time (23:00 UTC in winter, 22:00 UTC in summer)
        # Using 23:00 UTC as a safe default
        - cron: "0 23 * * *"

    workflow_dispatch:
        # Allow manual trigger from GitHub UI
        inputs:
            train_model:
                description: "Train/retrain the XGBoost model (also triggers TFT if enabled)"
                required: false
                default: "false"
                type: choice
                options:
                    - "false"
                    - "true"

jobs:
    trigger-pipeline:
        runs-on: ubuntu-latest

        steps:
            - name: Trigger Pipeline
              run: |
                  TRAIN_MODEL="${{ github.event.inputs.train_model || 'false' }}"

                  echo "Triggering pipeline with train_model=$TRAIN_MODEL"

                  RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
                    "${{ secrets.API_BASE_URL }}/api/pipeline/trigger?train_model=$TRAIN_MODEL&trigger_source=cron" \
                    -H "Authorization: Bearer ${{ secrets.PIPELINE_TRIGGER_SECRET }}" \
                    -H "Content-Type: application/json")

                  HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
                  BODY=$(echo "$RESPONSE" | sed '$d')

                  echo "Response code: $HTTP_CODE"
                  echo "Response body: $BODY"

                  if [ "$HTTP_CODE" -ne 200 ]; then
                    echo "Pipeline trigger failed with HTTP $HTTP_CODE"
                    exit 1
                  fi

                  echo "Pipeline job enqueued successfully"
                  echo "$BODY" | jq -r '.run_id' || true
